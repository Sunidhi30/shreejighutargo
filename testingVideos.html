<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Streaming</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #video-list, #continue-watching-list {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .video-card {
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    .video-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    .video-card h3 {
      margin: 10px;
      font-size: 18px;
    }
    video {
      width: 100%;
      margin-top: 20px;
    }
    #video-player-section {
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <h1>Approved Movies</h1>
  <div id="video-list"></div>

  <h2>Continue Watching</h2>
  <div id="continue-watching-list"></div>

  <div id="video-player-section" style="display:none;">
    <h2>Now Watching: <span id="now-watching-title"></span></h2>
    <video id="video-player" controls></video>
  </div>

 <!-- Inside <script> tag -->
<script>
    const API_URL = 'http://localhost:9000/api/users';
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySUQiOiI2N2ZjMGI2Yzc2YmFkMmExMmYzMTNhYTYiLCJlbWFpbCI6InJhdHJhc3VuaWRoaTZAZ21haWwuY29tIiwicm9sZSI6InVzZXIiLCJpYXQiOjE3NDU5MDgzNDgsImV4cCI6MTc0NjUxMzE0OH0.laj3gpKy_sx8v7vcJy4oHfoaLHjhyjN53ox-6iDRFYo'; // Replace with actual token
    const decodedToken = JSON.parse(atob(token.split('.')[1]));
    const userId = decodedToken.userID;
  
    const videoListDiv = document.getElementById('video-list');
    const continueWatchingListDiv = document.getElementById('continue-watching-list');
    const videoPlayerSection = document.getElementById('video-player-section');
    const videoPlayer = document.getElementById('video-player');
    const nowWatchingTitle = document.getElementById('now-watching-title');
  
    let currentVideoId = null;
    let currentVideoTimeTracked = false;
  
    async function fetchApprovedMovies() {
      try {
        const response = await fetch(`${API_URL}/approved-movies`);
        const movies = await response.json();
        displayMovies(movies, videoListDiv);
      } catch (error) {
        console.error('Error fetching approved movies:', error);
      }
    }
  
    async function fetchContinueWatching() {
      try {
        const response = await fetch(`${API_URL}/continue-watching`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        const data = await response.json();
        displayMovies(data.data, continueWatchingListDiv);
      } catch (error) {
        console.error('Error fetching continue watching list:', error);
      }
    }
  
    function displayMovies(movies, container) {
      container.innerHTML = '';
      movies.forEach(movie => {
        const videoData = movie.videoId || movie; // Populate-aware
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <img src="${videoData.thumbnail}" alt="${videoData.name}">
          <h3>${videoData.name}</h3>
        `;
        card.addEventListener('click', () => playVideo(videoData));
        container.appendChild(card);
      });
    }
  
    function playVideo(movie) {
      currentVideoId = movie._id;
      currentVideoTimeTracked = false;
  
      nowWatchingTitle.textContent = movie.name;
      videoPlayer.src = movie.video_480;
      videoPlayerSection.style.display = 'block';
      videoPlayer.currentTime = 0;
      videoPlayer.play();
    }
  
    videoPlayer.addEventListener('timeupdate', () => {
      if (!currentVideoTimeTracked && videoPlayer.currentTime > 10) {
        currentVideoTimeTracked = true;
        saveToContinueWatching(currentVideoId, videoPlayer.currentTime);
      }
    });
  
    async function saveToContinueWatching(videoId, progress) {
      try {
        await fetch(`${API_URL}/continue-watching`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ userId, videoId, progress })
        });
        console.log('Progress saved:', videoId, progress);
        fetchContinueWatching(); // refresh the list
      } catch (error) {
        console.error('Error saving to continue watching:', error);
      }
    }
  
    fetchApprovedMovies();
    fetchContinueWatching();
  </script>
  
</body>
</html>
