<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Razorpay Payment Test - Static Token</title>
</head>
<body>
  <h1>Test Razorpay Payment Integration</h1>

  <!-- Payment section -->
  <div id="payment-section">
    <h3>Current User: <span id="current-user"></span></h3>
    <input type="text" id="planId" placeholder="Plan ID" value="680539d76018e48c05d3d1dd">
    <button id="rzp-button">Pay ₹1</button>
    <button onclick="checkMySubscription()">Check My Subscription</button>
  </div>

  <div id="result"></div>

  <!-- Razorpay Checkout script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    // ✅ Use your actual static JWT token here
    let authToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySUQiOiI2ODJjMTZlMzEzNzgzNTY4Y2U0NWJmMGEiLCJlbWFpbCI6InN1cmJoaXNpbmdoYWwwMTAxMTk5OEBnbWFpbC5jb20iLCJyb2xlIjoidXNlciIsImlhdCI6MTc0ODU4NjY2OCwiZXhwIjoxNzQ5MTkxNDY4fQ.4bpuHGJsPYUq_5rSNyDCcErShojvyv-GvU_h7lH0qOM';
    let userEmail = 'surbhisinghal01011998@gmail.com'; // optional display email

    window.onload = function () {
      document.getElementById('payment-section').style.display = 'block';
      document.getElementById('current-user').textContent = userEmail;
    };

    // Payment function
    document.getElementById('rzp-button').onclick = async function () {
      try {
        const planId = document.getElementById('planId').value;

        // Create order
        const orderRes = await fetch('/api/users/create-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            planId: planId,
            paymentMethod: "razorpay"
          })
        });

        const orderData = await orderRes.json();
        console.log('Order created for user:', orderData.userId);

        if (!orderRes.ok || !orderData.orderId) {
          alert("❌ Failed to create Razorpay order: " + orderData.message);
          return;
        }

        // Open Razorpay
        const options = {
          key: "rzp_test_7m8iz2GqqZ6H9C", // Your test key
          amount: orderData.amount,
          currency: orderData.currency,
          name: "OTT Subscription",
          description: "Test Transaction",
          order_id: orderData.orderId,
          handler: async function (response) {
            const verifyRes = await fetch('/api/users/verify-payment', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
              },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                transactionId: orderData.transactionId,
                planId: planId
              })
            });

            const verifyResult = await verifyRes.json();
            console.log('Payment verification result:', verifyResult);

            if (verifyResult.success) {
              alert("✅ Payment verified successfully!");
              document.getElementById('result').innerHTML = 
                `<h3>✅ Success!</h3>
                 <p>Subscription created for user: ${verifyResult.subscription.user}</p>
                 <p>Plan: ${verifyResult.subscription.plan}</p>`;
            } else {
              alert("❌ Payment verification failed: " + verifyResult.message);
            }
          },
          theme: {
            color: "#3399cc"
          }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (error) {
        console.error(error);
        alert("❌ Something went wrong. Check console for details.");
      }
    };

    // Check subscription
    async function checkMySubscription() {
      try {
        const response = await fetch('/api/users/my-subscription', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const data = await response.json();
        console.log('My subscription:', data);

        if (data.success) {
          document.getElementById('result').innerHTML = 
            `<h3>My Active Subscription:</h3>
             <p>Plan: ${data.data.plan.name}</p>
             <p>Status: ${data.data.status}</p>
             <p>End Date: ${new Date(data.data.endDate).toLocaleDateString()}</p>`;
        } else {
          document.getElementById('result').innerHTML = 
            `<h3>No Active Subscription</h3>
             <p>${data.message}</p>`;
        }
      } catch (error) {
        console.error('Check subscription error:', error);
        alert('Failed to check subscription');
      }
    }
  </script>
</body>
</html>
